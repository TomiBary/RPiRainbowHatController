<!DOCTYPE html>
<html lang="cs">
  <head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>HydraT</title>
    <link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" rel="stylesheet">
<!--    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">-->
    <link href="/res/radial-progress.css" rel="stylesheet">
    <style>
        body {
            background-color: #e5ddd8;
        }

        .daily_target {
            width: 300px;
        }
        .progress-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background:
                    radial-gradient(closest-side, #e5ddd8 60%, transparent 80% 100%),
                    conic-gradient(#0081ff 75%, rgba(0, 47, 255, 0) 0);
        }

        .progress-bar::before {
            content: "75%";
        }

        .canvas-wrapper{
          max-width: 300px;
          max-height: 300px;
        }
    </style>
  </head>
  <body>
    <header class="container-fluid bg-primary text-white py-3">
      <h1 class="text-center">Hydratační tracker</h1>
    </header>
    <div class="pie-wrapper pie-wrapper--solid progress-88">
      <span class="label">88<span class="smaller">%</span></span>
    </div>

    <main class="container mt-5 text-center">
      <div class="row">
        <h2>Zadejte svůj denní cíl</h2>
        <div class="input-group mb-3 mx-auto daily_target">
          <label for="daily_target"></label><input class="form-control" id="daily_target" placeholder="Množství v mililitrech"
                                                   type="number">
          <span class="input-group-text">ml</span>
        </div>
        <h2>Vypité dnes</h2>
        <div class="h1 text-primary" id="current">0 ml</div>
        <div class="row p-3 canvas-wrapper">
          <canvas id="myChart" class="mx-auto" width="300" height="300"></canvas>
<!--          <div class="progress-bar progress-bar-value mx-auto"></div>-->
        </div>
      </div>

      <div class="row mt-3">
        <div class="col">
          <h2>Přidat sklenici</h2>
          <button class="btn btn-primary add-btn" id="add_100ml" data-add-amount="100">Přidat <b>100 ml</b></button>
          <button class="btn btn-primary add-btn" id="add_250ml" data-add-amount="250">Přidat <b>250 ml</b></button>
          <button class="btn btn-primary add-btn" id="add_500ml" data-add-amount="500">Přidat <b>500 ml</b></button>
        </div>
      </div>
      
      <button class="btn btn-primary" id="myButton" data-add-amount="100">Přidat <b>100 ml</b></button>
      <div class="row mt-5">
        <div class="col">
          <h2>Historie</h2>
          <ul class="list-group" id="historie">
          </ul>
        </div>
      </div>
    </main>

    <script crossorigin="anonymous"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/res/circle-progress.min.js" type="module"></script>
<!--    <script src="https://tigrr.github.io/circle-progress/js/circle-progress.js" type="module"></script>-->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const canvas = document.getElementById('myChart');
        const ctx = canvas.getContext('2d');

        const chart = new Chart(ctx, {
            type: 'doughnut', // Typ grafu - pro radiální progress bar použijte 'doughnut'
            data: {
                labels: ['Progress'], // Názvy segmentů (v tomto případě jen jeden)
                datasets: [{
                    label: 'Progress', // Označení pro segment
                    data: [0], // Počáteční hodnota (0)
                    backgroundColor: ['#f5f5f5'], // Barva segmentu
                    borderColor: ['#0081FF'], // Barva okraje segmentu
                    borderWidth: 2, // Šířka okraje segmentu
                }]
            },
            options: {
                cutoutPercentage: 80, // Velikost otvoru v grafu (0-100%)
                legend: {
                    display: false // Skrýt legendu
                },
                tooltips: {
                    enabled: false // Vypnout tooltip
                },
                responsive: true // Automaticky upravit graf pro různé rozměry
            }
        });

        // Funkce pro aktualizaci hodnoty progress baru
        function updateProgress(newValue) {
            daily_target_element = document.getElementById('daily_target')
            daily_target_element.value = newValue.daily_target

            current_element = document.getElementById('current')
            current_element.innerText = `${newValue.current} ml`
            // canvas.style.width = '25%';
            // canvas.style.height = '25%';
            chart.data.datasets[0].data[0] = newValue; // Nastavit novou hodnotu dat
            chart.update(); // Aktualizovat graf
        }

        // Příklad aktualizace progress baru na 50%
        updateProgress({current: 0.01, current_target: 0, daily_target: 2.5});

        async function sendHydrationRequest(data, callback) {
          const url = '/hydrat';

          try {
            const response = await fetch(url + '?' + ( new URLSearchParams( data ) ).toString(), {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json'
              },
              // body: JSON.stringify(data)
            });

            if (response.ok) {
              const responseData = await response.json();
              console.log(`Hydration request successful: ${JSON.stringify(responseData)}`);
              callback?.(responseData);
            } else {
              console.error(`Error sending hydration request: ${response.status}`);
            }
          } catch (error) {
            console.error(`Error sending hydration request: ${error}`);
          }
        }

        document.getElementById('myButton').addEventListener('click', function() {
          // Check if push notifications are supported and allowed
          if (navigator.serviceWorker && window.PushManager && window.Notification) {
            // Request permission to send push notifications
            navigator.serviceWorker.getRegistration().then(function(registration) {
              registration.pushManager.subscribe({ userVisibleOnly: true }).then(function(subscription) {
                console.log('Push notifications are allowed.');
                //save the push subscription in your database
              }).catch(function(error) {
                console.log('Error:', error);
              });
            });
          }
        });

        Notification.requestPermission().then(permission => {
          // alert(permission)
        })

        const notification = new Notification("Example notification", { 
          body: "This is more text",
          tag: "Come Back",
          data: {hello: "world"},
          icon: "https://fapcenter.g6.cz/images/adidas.jpg"
        })

        // let notification
        // document.addEventListener("visibility-change", ()=> {
        //   if(document.visibilityState === "hidden") {
        //     notification = new Notification("Come back please", {
        //       body: "Don't leave just yet :(",
        //       tag: "Come Back"
        //     })
        //   } else {
        //     notification.close()
        //   }
        // })
        notification. addEventListener("close", e => {
          console.log(e.target.data.hello)
        })

        Array.from(document.querySelectorAll('.add-btn')).forEach(e => e.addEventListener('click',function(){
          var amountLitres = e.getAttribute('data-add-amount') / 1000
          sendHydrationRequest({amountLitres}, updateProgress)
        }))

        sendHydrationRequest("", updateProgress)

        var intervalId = window.setInterval(function(){
          sendHydrationRequest("", updateProgress)
        }, 10000);



        // Zde bude nutné implementovat JavaScript logiku pro:
        // - Načítání a ukládání denního cíle
        // - Aktualizaci "Vypito dnes" po přidání sklenice
        // - Zobrazování historie vypitého množství
    </script>
  </body>
</html>